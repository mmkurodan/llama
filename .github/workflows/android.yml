name: Build native libs and APK

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  # ============================
  # ① OpenSSL (arm64) を CMake でビルド
  # ============================
  build-openssl:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt update
          sudo apt install -y git build-essential perl cmake

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Build OpenSSL 3.3.1 for arm64 (CMake)
        run: |
          set -e
          export API=24
          export HOST_TAG=linux-x86_64
          export TOOLCHAIN=$ANDROID_NDK/toolchains/llvm/prebuilt/$HOST_TAG

          git clone https://github.com/openssl/openssl.git
          cd openssl
          git checkout openssl-3.3.1

          mkdir build
          cd build

          cmake .. \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_SYSTEM_VERSION=$API \
            -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
            -DCMAKE_ANDROID_NDK=$ANDROID_NDK \
            -DCMAKE_ANDROID_STL_TYPE=c++_static \
            -DCMAKE_C_COMPILER=$TOOLCHAIN/bin/aarch64-linux-android$API-clang \
            -DCMAKE_CXX_COMPILER=$TOOLCHAIN/bin/aarch64-linux-android$API-clang++ \
            -DOPENSSL_USE_STATIC_LIBS=ON \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_INSTALL_PREFIX=$PWD/install

          make -j"$(nproc)"
          make install

      - name: Upload OpenSSL artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssl-arm64
          path: openssl/build/install

  # ============================
  # ② libcurl (arm64) をビルド
  # ============================
  build-libcurl:
    runs-on: ubuntu-latest
    needs: build-openssl

    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt update
          sudo apt install -y autoconf automake libtool pkg-config build-essential git

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b

      - name: Download OpenSSL artifact
        uses: actions/download-artifact@v4
        with:
          name: openssl-arm64
          path: openssl-arm64

      - name: Build libcurl for arm64
        run: |
          set -e
          git clone https://github.com/curl/curl.git
          cd curl
          git checkout curl-8_5_0

          autoreconf -fi

          export API=24
          export HOST_TAG=linux-x86_64
          export TOOLCHAIN=$ANDROID_NDK/toolchains/llvm/prebuilt/$HOST_TAG
          export CC=$TOOLCHAIN/bin/aarch64-linux-android${API}-clang
          export CXX=$TOOLCHAIN/bin/aarch64-linux-android${API}-clang++
          export AR=$TOOLCHAIN/bin/llvm-ar
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib

          ./configure \
            --host=aarch64-linux-android \
            --with-ssl=$GITHUB_WORKSPACE/openssl-arm64 \
            --disable-shared \
            --enable-static \
            --without-zstd \
            --without-brotli \
            --prefix=$PWD/build/arm64

          make -j"$(nproc)"
          make install

      - name: Upload libcurl artifact
        uses: actions/upload-artifact@v4
        with:
          name: libcurl-arm64
          path: curl/build/arm64

  # ============================
  # ③ APK ビルド（libcurl + OpenSSL を取り込む）
  # ============================
  build-apk:
    runs-on: ubuntu-latest
    needs: build-libcurl

    steps:
      - uses: actions/checkout@v4

      - name: Download OpenSSL artifact
        uses: actions/download-artifact@v4
        with:
          name: openssl-arm64
          path: app/src/main/cpp/third_party/openssl

      - name: Download libcurl artifact
        uses: actions/download-artifact@v4
        with:
          name: libcurl-arm64
          path: app/src/main/cpp/third_party/libcurl

      - name: Build debug APK
        run: ./gradlew assembleDebug
